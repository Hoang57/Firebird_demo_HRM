<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Employees</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Employee List</h1>
      <form
        id="searchForm"
        class="d-flex mb-4"
        onsubmit="searchEmployee(); return false;"
      >
        <input type="text" id="searchInput" class="form-control me-2" placeholder="Nhập tên hoặc mã nhân viên">
        <button type="submit" class="btn btn-primary me-2" onclick="searchEmployee()" >Search</button>
        <button
          type="button"
          class="btn btn-success me-2"
          data-bs-toggle="modal"
          data-bs-target="#addEmployeeModal"
        >
          Add
        </button>

        <!-- Modal -->
        <div
          class="modal fade"
          id="addEmployeeModal"
          tabindex="-1"
          aria-labelledby="addEmployeeModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg"> <!-- Thêm modal-lg để popup to hơn -->
            <div class="modal-content">
              <div class="modal-header">
          <h5 class="modal-title" id="addEmployeeModalLabel">
            Add Employee
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
              </div>
              <div class="modal-body">{% include 'add_employee.html' %}</div>
            </div>
          </div>
        </div>

        <!-- <button type="submit" formaction="/delete_employee" formmethod="POST" class="btn btn-danger">Delete</button>-->
      </form>
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Position</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="employeeTable"></tbody>
      </table>
    </div>

    <script>
      function searchEmployee() {
        const keyword = document.getElementById("searchInput").value.trim();
        fetch(`/api/employee?query=${encodeURIComponent(keyword)}`)
          .then((response) => response.json())
          .then((data) => {
            const tbody = document.getElementById("employeeTable");
            tbody.innerHTML = "";

            if (data.length === 0) {
              tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">Không tìm thấy nhân viên nào.</td>
                    </tr>
                `;
              return;
            }

            data.forEach((emp) => {
              const row = `
                    <tr>
                        <td>${emp.MANV}</td>
                        <td>${emp.HOTEN}</td>
                        <td>${emp.MACV}</td>
                        <td>${emp.MAPB}</td>
                        <td>
                            <a href="/edit_employee/${emp.MANV}" class="btn btn-warning btn-sm">Sửa</a>
                            <a href="/delete_employee/${emp.MANV}" class="btn btn-danger btn-sm">Xóa</a>
                        </td>
                    </tr>
                `;
              tbody.innerHTML += row;
            });
          })
          .catch((err) => {
            console.error("Lỗi khi gọi API:", err);
          });
      }

    document.addEventListener("DOMContentLoaded", function () {
      debugger;
  const modal = document.getElementById("addEmployeeModal");

  if (!modal) {
    console.error("Không tìm thấy modal với id 'addEmployeeModal'.");
    return;
  }
  // Bắt sự kiện khi modal hiển thị (sau khi được bật lên)
    modal.addEventListener("shown.bs.modal", function () {
      debugger;
          const form = modal.querySelector("#employeeForm");

          if (!form) {
            console.error("Không tìm thấy form với id 'employeeForm' bên trong modal.");
            return;
          }

          // Đảm bảo không gán nhiều lần sự kiện nếu modal được mở lại
          if (!form.dataset.listenerAttached) {
            form.addEventListener("submit", function (event) {
              event.preventDefault();

              const data = {
                HOTEN: form.name.value,
                NGAYSINH: form.dob.value,
                GIOITINH: form.gender.value,
                SDT: form.phone.value,
                EMAIL: form.email.value,
                DIACHI: form.address.value,
                PHONGBAN: form.department.value,
                CHUCVU: form.position.value,
              };

              fetch("/api/insert_employee", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
              })
                .then((response) => response.json())
                .then((result) => {
                  if (result.message) {
                    alert(result.message);
                    form.reset();

                    // Đóng modal
                    const bootstrapModal = bootstrap.Modal.getInstance(modal);
                    if (bootstrapModal) {
                      bootstrapModal.hide();
                    }
                  } else {
                    alert("Lỗi: " + result.error);
                  }
                })
                .catch((error) => {
                  console.error("Lỗi khi gửi dữ liệu:", error);
                  alert("Đã xảy ra lỗi khi gửi dữ liệu.");
                });
            });

            // Gắn cờ để tránh đăng ký nhiều lần
            form.dataset.listenerAttached = "true";
          }
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
