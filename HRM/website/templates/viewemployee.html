<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Employees</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Employee List</h1>
      <form
        id="searchForm"
        class="d-flex mb-4"
        onsubmit="searchEmployee(); return false;"
      >
        <input type="text" id="searchInput" class="form-control me-2" placeholder="Nhập tên hoặc mã nhân viên" />
        <button type="submit" class="btn btn-primary me-2">Search</button>
        <button
          type="button"
          class="btn btn-success me-2"
          data-bs-toggle="modal"
          data-bs-target="#addEmployeeModal"
        >
          Add
        </button>
      </form>

      <!-- Modal Add_employee -->
      <div
        class="modal fade"
        id="addEmployeeModal"
        tabindex="-1"
        aria-labelledby="addEmployeeModalLabel"
        aria-hidden="true"
      >
      <!-- Modal Add_employee -->
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addEmployeeModalLabel">Add Employee</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form id="employeeForm">
                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="name" class="form-label">Name:</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label for="dob" class="form-label">Date of Birth:</label>
                    <input type="date" id="dob" name="dob" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label for="gender" class="form-label">Gender:</label>
                    <select id="gender" name="gender" class="form-select" required>
                      <option value="" disabled selected>Select Gender</option>
                      <option value="Nam">Male</option>
                      <option value="Nữ">Female</option>
                      <option value="Khác">Other</option>
                    </select>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="phone" class="form-label">Phone Number:</label>
                    <input type="tel" id="phone" name="phone" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label">Email:</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="address" class="form-label">Address:</label>
                  <input type="text" id="address" name="address" class="form-control" required>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="department" class="form-label">Department:</label>
                    <input type="text" id="department" name="department" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label for="position" class="form-label">Position:</label>
                    <input type="text" id="position" name="position" class="form-control" required>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary">Add Employee</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Edit Employee -->
        <div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editEmployeeModalLabel">
                  <i class="bi bi-pencil-square me-2"></i>Edit Employee
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body row g-4 align-items-center">
                <!-- Leftside- Image -->
                <div class="col-md-4 text-center">
                  <div class="p-3 bg-light rounded shadow-sm">
                    <img id="editEmployeeImage" src="" alt="Employee Photo" class="img-fluid rounded-circle border border-3 border-primary mb-3" style="max-height: 220px; object-fit: cover;" />
                    <h6 class="mt-2 text-secondary">Profile Photo</h6>
                  </div>
                </div>
                <!-- Right side - Employee info -->
                <div class="col-md-8">
                  <form id="editEmployeeForm" autocomplete="off">
                    <input type="hidden" id="editMANV" name="MANV" />
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="editHOTEN" class="form-label fw-semibold">Name</label>
                        <input type="text" id="Name" name="NAME" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editNGAYSINH" class="form-label fw-semibold">Date of Birth</label>
                        <input type="date" id="DOB" name="DOB" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editDIACHI" class="form-label fw-semibold">Gender</label>
                        <input type="text" id="Gender" name="GENDER" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editDIACHI" class="form-label fw-semibold">Address</label>
                        <input type="text" id="Address" name="ADDRESS" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editSODT" class="form-label fw-semibold">Phone</label>
                        <input type="tel" id="PhoneNum" name="SODT" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editEMAIL" class="form-label fw-semibold">Email</label>
                        <input type="email" id="editEMAIL" name="EMAIL" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editNGAYVAOLAM" class="form-label fw-semibold">Join Date</label>
                        <input type="date" id="JoinDate" name="JOIN_DATE" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editMAPB" class="form-label fw-semibold">Department</label>
                        <input type="text" id="DepartmentID" name="DEPARTMENT" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editMACV" class="form-label fw-semibold">Position</label>
                        <input type="text" id="PositionID" name="POSITION" class="form-control" required />
                      </div>
                      <div class="col-md-6">
                        <label for="editTRANGTHAI" class="form-label fw-semibold">Status</label>
                        <select id="Status" name="STATUS" class="form-select" required>
                          <option value="Đang làm">Đang làm</option>
                          <option value="Nghỉ việc">Nghỉ việc</option>
                        </select>
                      </div>
                    </div>
                    <div class="mt-4 d-flex justify-content-end">
                      <button type="submit" class="btn btn-success px-4">
                        <i class="bi bi-save me-2"></i>Update
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Bootstrap Icons CDN -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
      <!-- Modal Edit Employee -->
      <table class="table table-bordered table-striped mt-4">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Position</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="employeeTable"></tbody>
      </table>
    </div>

    <!-- Pagination: căn phải -->
    <div class="d-flex justify-content-end mt-3">
      <nav>
        <ul id="pagination" class="pagination mb-0"></ul>
      </nav>
    </div>

    <script>

      let allEmployees = [];
      let currentPage = 1;
      const recordsPerPage = 10;

      function searchEmployee() {
        debugger;
        const keyword = document.getElementById("searchInput").value.trim();
        debugger;
        fetch(`/api/employee?query=${encodeURIComponent(keyword)}`)
          .then((response) => response.json())
          .then((data) => {
            allEmployees = data;
            currentPage = 1;
            renderTable();
            renderPagination();
          })
          .catch((err) => {
            console.error("Lỗi khi gọi API:", err);
          });
      }

      function renderTable() {
        const tbody = document.getElementById("employeeTable");
        tbody.innerHTML = "";

        const start = (currentPage - 1) * recordsPerPage;
        const end = start + recordsPerPage;
        const pageData = allEmployees.slice(start, end);

        if (pageData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">Không tìm thấy nhân viên nào.</td>
            </tr>
          `;
          return;
        }

        pageData.forEach((emp) => {
          const row = `
            <tr>
              <td>${emp.MANV}</td>
              <td>${emp.HOTEN}</td>
              <td>${emp.MACV}</td>
              <td>${emp.MAPB}</td>
              <td>
                <a onclick="openEditModal('${emp.MANV}')" class="btn btn-warning btn-sm">Edit</a>
                <a href="#" class="btn btn-danger btn-sm" onclick="deleteEmployee('${ emp.MANV }')">Delete</a>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      function renderPagination() {
        const totalPages = Math.ceil(allEmployees.length / recordsPerPage);
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = "page-item" + (i === currentPage ? " active" : "");
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.querySelector("a").addEventListener("click", function (e) {
            e.preventDefault();
            currentPage = i;
            renderTable();
            renderPagination();
          });
          pagination.appendChild(li);
        } 
      }



      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("employeeForm");
        form.addEventListener("submit", function (event) {
          event.preventDefault();

          const data = {
            HOTEN: form.name.value,
            NGAYSINH: form.dob.value,
            GIOITINH: form.gender.value,
            DIACHI: form.address.value,
            SODT: form.phone.value,
            EMAIL: form.email.value,
            MAPB: form.department.value,
            MACV: form.position.value,
          };

          fetch("/api/insert_employee", {
            method: "POST", 
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => response.json())
            .then((result) => {
              if (result.message) {
                alert(result.message);
                form.reset();

                const modalEl = document.getElementById("addEmployeeModal");
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                  modalInstance.hide();
                }

                searchEmployee(); // Tải lại bảng dữ liệu
              } else {
                alert("Lỗi: " + result.error);
              }
            })
            .catch((error) => {
              console.error("Send data error:", error);
              alert("Send data error.");
            });
        });
      });


      function openEditModal(manv) {
        debugger;
        fetch(`/api/get_emp?emp_id=${encodeURIComponent(manv)}`)
          .then((res) => res.json())
          .then((emp) => {
            document.getElementById("editMANV").value = emp.MANV;
            document.getElementById("Name").value = emp.HOTEN;
            document.getElementById("DOB").value = emp.NGAYSINH;
            document.getElementById("Gender").value = emp.GIOITINH;
            document.getElementById("Address").value = emp.DIACHI;
            document.getElementById("PhoneNum").value = emp.SODT;
            document.getElementById("editEMAIL").value = emp.EMAIL;
            document.getElementById("JoinDate").value = emp.NGAYVAOLAM;
            document.getElementById("DepartmentID").value = emp.MAPB;
            document.getElementById("PositionID").value = emp.MACV;
            document.getElementById("Status").value = emp.TRANGTHAI;

            // Gán ảnh nếu có (giả định tên ảnh là theo mã nhân viên)
            document.getElementById("editEmployeeImage").src = emp.ANH || `/static/images/employees/${emp.MANV}.jpg`;

            const modal = new bootstrap.Modal(document.getElementById("editEmployeeModal"));
            modal.show();
          });
      }

      document.getElementById("editEmployeeForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const data = {
          MANV: document.getElementById("editMANV").value,
          HOTEN: document.getElementById("Name").value,
          NGAYSINH: document.getElementById("DOB").value,
          GIOITINH: document.getElementById("Gender").value,
          DIACHI: document.getElementById("Address").value,
          SODT: document.getElementById("PhoneNum").value,
          EMAIL: document.getElementById("editEMAIL").value,
          NGAYVAOLAM: document.getElementById("JoinDate").value,
          MAPB: document.getElementById("DepartmentID").value,
          MACV: document.getElementById("PositionID").value,
          TRANGTHAI: document.getElementById("Status").value,
        };
        console.log("Dữ liệu gửi đi:", data);

        fetch(`/api/update_employee/${data.MANV}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((res) => res.json())
          .then((result) => {
            alert(result.message || "Update Successful!");
            bootstrap.Modal.getInstance(document.getElementById("editEmployeeModal")).hide();
            searchEmployee();
          })
          .catch((err) => {
            console.error("Update error:", err);
            alert("Error!");
          });
      });

      function deleteEmployee(manv) {
        if (!manv) {
          alert("Mã nhân viên không hợp lệ.");
          return;
        }

        if (confirm(`Bạn có chắc chắn muốn xóa nhân viên có mã: ${manv}?`)) {
          fetch(`/api/delete_employee/${manv}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}) // Gửi rỗng nếu API không yêu cầu thêm
          })
            .then((res) => res.json())
            .then((result) => {
              if (result.message) {
                alert("Xóa nhân viên thành công!");
                searchEmployee(); // Làm mới danh sách nhân viên
              } else {
                alert(result.error || "Xóa thất bại.");
              }
            })
            .catch((err) => {
              console.error("Delete error:", err);
              alert("Đã xảy ra lỗi khi xóa nhân viên.");
            });
        }
      }


     
  
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
